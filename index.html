<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Finatics Aquatics - African Cichlid Breeders" />
  <title>Finatics Aquatics</title>
  <link rel="stylesheet" href="css/style.css" />
  <script defer>
    const sheetUrl = 'https://script.google.com/macros/s/AKfycby7R9zrOBS-pg0AwxU_yRaKLo6VUWM8oPjLFkZhiJyl2SkTVw98ENSsO3iC3ISHYqSd/exec';
    let stockData = {};
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function fetchStock() {
      fetch(sheetUrl)
        .then(response => response.json())
        .then(data => {
          const grouped = {};
          data.forEach(entry => {
            const {
              fishName,
              size,
              price,
              stock,
              type = 'Uncategorized',
              category = 'General',
              subcategory = '',
              subcategory2 = '',
              subcategory3 = ''
            } = entry;

            const path = [type, category, subcategory, subcategory2, subcategory3].filter(Boolean);
            const key = path.join(' > ');
            if (!grouped[key]) grouped[key] = {};
            if (!grouped[key][fishName]) grouped[key][fishName] = [];
            grouped[key][fishName].push({ size, price, stock });
          });

          stockData = grouped;
          const loadingEl = document.getElementById('loading');
          if (loadingEl) loadingEl.style.display = 'none';

          const sortedFish = Object.keys(stockData).sort();
          for (const fish of sortedFish) {
            const items = stockData[fish];
            const card = document.createElement('div');
            card.className = 'fish-card';

            const img = document.createElement('img');
            const baseName = fish.toLowerCase().replace(/\s+/g, '-');
            img.src = `images/${baseName}.jpg`;
            img.alt = fish;
            img.onerror = () => {
              img.onerror = null;
              img.src = `images/${baseName}.png`;
              img.onerror = () => {
                img.src = 'images/fallback.png';
              };
            };
            card.appendChild(img);

            const title = document.createElement('h3');
            title.textContent = fish;
            card.appendChild(title);

            const selector = document.createElement('div');
            selector.className = 'selector';

            const sizeSelect = document.createElement('select');
            sizeSelect.style.width = '200px';
            sizeSelect.innerHTML = '<option value="">Choose a size</option>';
            items.forEach(entry => {
              if (entry.stock === 0) return;
              const opt = document.createElement('option');
              opt.value = JSON.stringify(entry);
              opt.textContent = `${entry.size} — £${entry.price} — Stock: ${entry.stock}`;
              sizeSelect.appendChild(opt);
            });

            const qtyInput = document.createElement('input');
            qtyInput.type = 'number';
            qtyInput.min = '1';
            qtyInput.value = '1';
            qtyInput.placeholder = 'Qty';

            const addBtn = document.createElement('button');
            addBtn.textContent = 'Add to Cart';
            addBtn.addEventListener('click', () => {
              const selected = sizeSelect.value;
              const quantity = parseInt(qtyInput.value);
              if (!selected || isNaN(quantity) || quantity < 1) {
                alert('Please select a size and quantity.');
                return;
              }

              const { size, price } = JSON.parse(selected);
              cart.push({ fish, size, quantity, price });
              renderCart();
            });

            selector.appendChild(sizeSelect);
            selector.appendChild(qtyInput);
            selector.appendChild(addBtn);
            card.appendChild(selector);
            grid.appendChild(card);
          }

          renderCart();
        })
        .catch(err => console.error('Failed to fetch stock:', err));
    }

    function renderCart() {
      const cartItems = document.getElementById('cart-items');
      const cartTotal = document.getElementById('cart-total');
      cartItems.innerHTML = '';
      let totalAmount = 0;

      cart.forEach((item, index) => {
        const subtotal = item.quantity * item.price;
        const li = document.createElement('li');
        li.innerHTML = `${item.quantity} x ${item.fish} (${item.size}) — £${subtotal} <button data-index="${index}" class="remove-btn" style="margin-left: 10px; background-color: #e63946; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Remove</button>`;
        cartItems.appendChild(li);
        totalAmount += subtotal;
      });

      cartTotal.textContent = totalAmount > 0 ? `Total: £${totalAmount}` : '';
      localStorage.setItem('cart', JSON.stringify(cart));

      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.getAttribute('data-index'));
          cart.splice(index, 1);
          renderCart();
        });
      });
    }

    function updateOrderSummaryField() {
      let totalAmount = 0;
      const orderSummary = cart.map(item => {
        const subtotal = item.quantity * item.price;
        totalAmount += subtotal;
        return `${item.quantity} x ${item.fish} (${item.size}) — £${subtotal}`;
      }).join('\n');
      const fullSummary = `${orderSummary}\n\nTotal: £${totalAmount}`;
      const orderInput = document.getElementById('order-summary');
      if (orderInput) orderInput.value = fullSummary;
    }

    function appendDeliveryToURL() {
      const form = document.getElementById('order-form');
      const delivery = document.getElementById('delivery').value;
      form.action += `?delivery=${encodeURIComponent(delivery)}`;
      return true;
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchStock();
      const clearCartBtn = document.getElementById('clear-cart');
      if (clearCartBtn) {
        clearCartBtn.addEventListener('click', () => {
          cart.length = 0;
          localStorage.removeItem('cart');
          document.getElementById('cart-items').innerHTML = '';
          document.getElementById('cart-total').textContent = '';
        });
      }
    });
  
      // Build dynamic nav
      const navList = document.getElementById('dynamic-nav');
      if (navList) {
        Object.keys(stockData).sort().forEach(path => {
          const sectionId = path.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `#${sectionId}`;
          a.textContent = path;
          li.appendChild(a);
          navList.insertBefore(li, navList.querySelector('li:nth-child(2)'));
        });
      }
    </script>
</head>
<body>
  <header class="hero">
    <img src="images/FinaticsCoveringPhoto.png" alt="Finatics Aquatics Banner" class="hero-image" />
    <div class="hero-overlay">
      <img src="images/FinaticsAquaticsLogoV2.png" alt="Finatics Aquatics Logo" class="hero-logo" />
      <h1 class="hero-title">Bred With Passion. <br />Raised With Care.</h1>
    </div>
  </header>

  <nav>
    <div style="text-align: center; margin-top: 0.5em;">
        <button onclick="document.body.classList.toggle('dark-mode')" style="background: #444; color: #fff; border: none; padding: 0.5em 1em; border-radius: 4px; cursor: pointer;">
          Toggle Dark Mode
        </button>
      </div>      
    <ul id="dynamic-nav">
      <li><a href="#available">All Fish</a></li>
      <li><a href="#setup">Our Setup</a></li>
      <li><a href="#about">About Us</a></li>
      <li><a href="#contact">Contact</a></li>
    </ul>
  </nav>

  <main>
    <section id="available">
      <h2>All Fish</h2>
      <div id="loading" style="text-align: center; font-weight: bold; padding: 1em;">Loading available fish...</div>
      <h2>Available Fish</h2>
      <div class="fish-grid" id="fish-grid"></div>
    </section>

    

    <section id="cart">
      <h3>Cart</h3>
      <label for="customer-name">Name</label>
      <input type="text" id="customer-name" name="name" placeholder="Your name" required>
      <label for="customer-email">Email</label>
      <input type="email" id="customer-email" name="email" placeholder="Your email" required>
      <ul id="cart-items"></ul>
      <p id="cart-total"></p>
      <button id="clear-cart">Clear Cart</button>
      <form id="order-form" action="https://formspree.io/f/mwpobwwy" method="POST" onsubmit="return appendDeliveryToURL()">
        <label for="delivery">Delivery Method</label>
        <select id="delivery" name="delivery" required>
          <option value="">Select delivery or pickup</option>
          <option value="Delivery" selected>Delivery</option>
          <option value="Pickup">Pickup</option>
        </select>
        <input type="hidden" id="order-summary" name="order" value="">
        <button type="submit" onclick="updateOrderSummaryField()">Submit Order</button>
      </form>
      <p style="background-color: #d4edda; color: #155724; padding: 1rem; border: 1px solid #c3e6cb; border-radius: 6px; font-weight: bold; margin-top: 1rem;">
        ✅ Once submitted, we’ll be in touch to confirm your order. Please check your email (and junk folder) for updates. Your selected delivery method will also be shown on the confirmation page.
      </p>
    </section>

    <section id="setup">
      <h2>Our Breeding Setup</h2>
      <p>We use a modular tank system with clean water cycling and natural filtration through aquaponics. Each breeding pair is given a dedicated tank to ensure quality offspring and optimal health.</p>
    </section>

    <section id="about">
      <h2>About Us</h2>
      <p>We are a family-run breeder in the UK, passionate about African cichlids. Our goal is to produce vibrant, healthy fish raised in a loving environment. From tank care to feeding routines, we involve our children in every part of the process.</p>
    </section>

    <section id="contact">
      <h2>Contact Us</h2>
      <p>Email: <a href="mailto:info@finaticsaquatics.com">info@finaticsaquatics.com</a></p>
      <p>WhatsApp: 07XXX XXXXXX</p>
      <p>Follow us on Facebook and Instagram</p>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Finatics Aquatics. All rights reserved.</p>
    <p><a href="https://finatic-andrewbetteridge.github.io/FinaticsAquatics.github.io-/">Visit our live site</a></p>
  </footer>
</body>
</html>
